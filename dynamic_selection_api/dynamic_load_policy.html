
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Dynamic Load Policy &#8212; oneDPL Documentation 2022.3.0 documentation</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <link rel="shortcut icon" href="../_static/favicons.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Auto-Tune Policy" href="auto_tune_policy.html" />
    <link rel="prev" title="Round-Robin Policy" href="round_robin_policy.html" />

    <script defer type="text/javascript" src="https://www.intel.com/content/dam/www/global/wap/performance-config.js" ></script>
    <script type="text/javascript">
        // Configure TMS settings
        var wapLocalCode = 'us-en'; // Dynamically set per localized site, see mapping table for values
        var wapSection = "oneapi-dpl"; // WAP team will give you a unique section for your site
        // Load TMS
        if(document.location.href.includes("oneapi-src.github.io")){
        (function () {
        var url = 'https://www.intel.com/content/dam/www/global/wap/tms-loader.js'; // WAP file URL
        var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true; po.src = url;
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
        }
    </script>
    <link href="../_static/style.css" rel="stylesheet" type="text/css">



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/oneAPI-rgb-rev-100.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">oneDPL Documentation 2022.3.0 documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p>
 <span class="caption-text">
  Get Started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/release_notes.html">
   Release Notes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/onedpl_gsg.html">
   Get Started with the oneAPI DPC++ Library
  </a>
 </li>
</ul>
<p>
 <span class="caption-text">
  Library Guide
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction.html">
   oneAPI DPC++ Library Introduction
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../parallel_api_main.html">
   Parallel API
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../parallel_api/execution_policies.html">
     Execution Policies
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../parallel_api/iterators.html">
     Iterators
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../parallel_api/async_api.html">
     Asynchronous API Algorithms
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../parallel_api/range_based_api.html">
     Range-Based API Algorithms
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../parallel_api/additional_algorithms.html">
     Additional Algorithms
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../parallel_api/pass_data_algorithms.html">
     Pass Data to Algorithms
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../api_for_sycl_kernels_main.html">
   API for the SYCL* Kernels
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../api_for_sycl_kernels/random.html">
     Random Number Generators
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../api_for_sycl_kernels/tested_standard_cpp_api.html">
     Tested Standard C++ APIs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../api_for_sycl_kernels/utility_function_object_classes.html">
     Utility Function Object Classes
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../dynamic_selection_api_main.html">
   Dynamic Selection API
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="functions.html">
     Functions
    </a>
   </li>
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="policies.html">
     Policies
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
    <label for="toctree-checkbox-4">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3">
      <a class="reference internal" href="fixed_resource_policy.html">
       Fixed-Resource Policy
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="round_robin_policy.html">
       Round-Robin Policy
      </a>
     </li>
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="#">
       Dynamic Load Policy
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="auto_tune_policy.html">
       Auto-Tune Policy
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../macros.html">
   Macros
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../cmake_support.html">
   CMake Support
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../oneDPL_2022.0_changes.html">
   oneDPL 2022 Breaking Changes
  </a>
 </li>
</ul>
<p>
 <span class="caption-text">
  Notices and Disclaimers
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../notices_disclaimers.html">
   Notices and Disclaimers
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/oneapi-src/oneDPL/issues/new?title=Issue%20on%20page%20%2Fdynamic_selection_api/dynamic_load_policy.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/oneapi-src/oneDPL/edit/main/documentation/library_guide/dynamic_selection_api/dynamic_load_policy.rst"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/dynamic_selection_api/dynamic_load_policy.rst.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.rst</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example">
   Example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#selection-algorithm">
   Selection Algorithm
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#constructors">
   Constructors
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deferred-initialization">
   Deferred Initialization
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#queries">
   Queries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reporting-requirements">
   Reporting Requirements
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Dynamic Load Policy</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example">
   Example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#selection-algorithm">
   Selection Algorithm
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#constructors">
   Constructors
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deferred-initialization">
   Deferred Initialization
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#queries">
   Queries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reporting-requirements">
   Reporting Requirements
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section id="dynamic-load-policy">
<h1>Dynamic Load Policy<a class="headerlink" href="#dynamic-load-policy" title="Permalink to this headline">¶</a></h1>
<p>The dynamic selection API is an experimental feature in the oneAPI DPC++ Library
(oneDPL) that selects an <em>execution resource</em> based on a chosen
<em>selection policy</em>. There are several policies provided as part
of the API. Policies encapsulate the logic and any associated state needed
to make a selection.</p>
<p>The dynamic load policy tracks the number of submissions currently submitted but not yet completed on each
resource and selects the resource that has the fewest unfinished submissions.
<code class="docutils literal notranslate"><span class="pre">dynamic_load_policy</span></code> is useful for offloading kernels of varying cost to devices
of varying performance. A load-based assignment may achieve a good load balancing
by submitting tasks to a resource that completes work faster.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="nn">oneapi</span><span class="o">::</span><span class="nn">dpl</span><span class="o">::</span><span class="nn">experimental</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl_backend</span><span class="o">&gt;</span>
<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">dynamic_load_policy</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// useful types</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">resource_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">Backend</span><span class="o">::</span><span class="n">resource_type</span><span class="p">;</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">wait_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">Backend</span><span class="o">::</span><span class="n">wait_type</span><span class="p">;</span>

<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">selection_type</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">public</span><span class="o">:</span>
<span class="w">      </span><span class="n">dynamic_load_policy</span><span class="o">&lt;</span><span class="n">Backend</span><span class="o">&gt;</span><span class="w"> </span><span class="n">get_policy</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="w">      </span><span class="n">resource_type</span><span class="w"> </span><span class="nf">unwrap</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// constructors</span>
<span class="w">    </span><span class="n">dynamic_load_policy</span><span class="p">(</span><span class="n">deferred_initialization_t</span><span class="p">);</span>
<span class="w">    </span><span class="n">dynamic_load_policy</span><span class="p">();</span>
<span class="w">    </span><span class="n">dynamic_load_policy</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">resource_type</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">u</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// deferred initializer</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize</span><span class="p">();</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">resource_type</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">u</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// queries</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">get_resources</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">get_submission_group</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// other implementation defined functions...</span>
<span class="w">  </span><span class="p">};</span>

<span class="p">}</span>
</pre></div>
</div>
<p>This policy can be used with all the dynamic selection functions, such as <code class="docutils literal notranslate"><span class="pre">select</span></code>, <code class="docutils literal notranslate"><span class="pre">submit</span></code>,
and <code class="docutils literal notranslate"><span class="pre">submit_and_wait</span></code>. It can also be used with <code class="docutils literal notranslate"><span class="pre">policy_traits</span></code>.</p>
<section id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>The following example demonstrates a simple approach to send work to more than
one queue concurrently using <code class="docutils literal notranslate"><span class="pre">dynamic_load_policy</span></code>. The policy selects the
resource with the fewest number of unfinished submissions.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;oneapi/dpl/dynamic_selection&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/sycl.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>

<span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">ex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">oneapi</span><span class="o">::</span><span class="nn">dpl</span><span class="o">::</span><span class="nn">experimental</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">sycl</span><span class="o">::</span><span class="n">handler</span><span class="o">&amp;</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">do_cpu_work</span><span class="p">();</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">dynamic_load_example</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">sycl</span><span class="o">::</span><span class="n">queue</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">devices</span><span class="p">,</span>
<span class="w">                         </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="w"> </span><span class="o">*&gt;&amp;</span><span class="w"> </span><span class="n">usm_data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="n">ex</span><span class="o">::</span><span class="n">dynamic_load_policy</span><span class="w"> </span><span class="n">p</span><span class="p">{</span><span class="n">devices</span><span class="p">};</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">num_devices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">get_resources</span><span class="p">().</span><span class="n">size</span><span class="p">();</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">num_arrays</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usm_data</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="w">  </span><span class="c1">// (2)</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">submission_group_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num_arrays</span><span class="p">;</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Running with &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">num_devices</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; queues</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">            </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;             &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">num_arrays</span><span class="w">  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; usm arrays</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">            </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Will perform &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">submission_group_size</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; concurrent offloads</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>


<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">+=</span><span class="n">submission_group_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">submission_group_size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// (4)</span>
<span class="w">      </span><span class="n">ex</span><span class="o">::</span><span class="n">submit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">sycl</span><span class="o">::</span><span class="n">queue</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (5)</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usm_data</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">=</span><span class="p">](</span><span class="n">sycl</span><span class="o">::</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// (6)</span>
<span class="w">          </span><span class="n">f</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="n">do_cpu_work</span><span class="p">();</span><span class="w"> </span><span class="c1">// (7)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">ex</span><span class="o">::</span><span class="n">wait</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">get_submission_group</span><span class="p">());</span><span class="w"> </span><span class="c1">// (8)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The key points in this example are:</p>
<ol class="arabic simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">dynamic_load_policy</span></code> is constructed that selects from queues in the <code class="docutils literal notranslate"><span class="pre">devices</span></code> vector.</p></li>
<li><p>The total number of concurrent offloads, <code class="docutils literal notranslate"><span class="pre">submission_group_size</span></code>, will be limited to the number of USM arrays. In this example, we allow multiple simultaneous offloads to the same queue. The only limitation is that there should be enough available vectors to support the concurrent executions.</p></li>
<li><p>The outer <code class="docutils literal notranslate"><span class="pre">i</span></code>-loop iterates from 0 to 99, stepping by the <code class="docutils literal notranslate"><span class="pre">submission_group_size</span></code>. This number of submissions will be offloaded concurrently.</p></li>
<li><p>The inner <code class="docutils literal notranslate"><span class="pre">j</span></code>-loop iterates over <code class="docutils literal notranslate"><span class="pre">submission_group_size</span></code> submissions.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">submit</span></code> is used to select a queue and pass it to the user’s function, but does not block until the event returned by that function completes. This provides the opportunity for concurrency across the submissions.</p></li>
<li><p>The queue is used in a function to perform an asynchronous offload. The SYCL event returned from the call to <code class="docutils literal notranslate"><span class="pre">submit</span></code> is returned. Returning an event is required for functions passed to <code class="docutils literal notranslate"><span class="pre">submit</span></code> and <code class="docutils literal notranslate"><span class="pre">submit_and_wait</span></code>.</p></li>
<li><p>Some additional work is done between calls to <code class="docutils literal notranslate"><span class="pre">submit</span></code>. <code class="docutils literal notranslate"><span class="pre">dynamic_load_policy</span></code> is most useful when there is time for work to complete on some devices before the next assignment is made. If all submissions are performed simultaneously, all devices will appear equally loaded, since the fast devices would have had no time to complete their work.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">wait</span></code> is called to block for all the concurrent <code class="docutils literal notranslate"><span class="pre">submission_group_size</span></code> submissions to complete.</p></li>
</ol>
</section>
<section id="selection-algorithm">
<h2>Selection Algorithm<a class="headerlink" href="#selection-algorithm" title="Permalink to this headline">¶</a></h2>
<p>The selection algorithm for <code class="docutils literal notranslate"><span class="pre">dynamic_load_policy</span></code> chooses the resource
that has the fewest number of unfinished offloads. The number of unfinished
offloads is the difference between the number of reported task submissions
and then number of reported task completions. This value is tracked for each
available resource.</p>
<p>Simplified, expository implementation of the selection algorithm:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">template</span><span class="o">&lt;</span><span class="n">typename</span><span class="o">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<span class="n">selection_type</span> <span class="n">dynamic_load_policy</span><span class="p">::</span><span class="n">select</span><span class="p">(</span><span class="n">Args</span><span class="o">&amp;&amp;</span> <span class="o">...</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">initialized_</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">auto</span> <span class="n">least_loaded_resource</span> <span class="o">=</span> <span class="n">find_least_loaded</span><span class="p">(</span><span class="n">resources_</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">selection_type</span><span class="p">{</span><span class="n">dynamic_load_policy</span><span class="o">&lt;</span><span class="n">Backend</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">),</span> <span class="n">least_loaded</span><span class="p">};</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">throw</span> <span class="n">std</span><span class="p">::</span><span class="n">logic_error</span><span class="p">(</span><span class="s2">&quot;select called before initialialization&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">resources_</span></code> is a container of resources, such as
<code class="docutils literal notranslate"><span class="pre">std::vector</span></code> of <code class="docutils literal notranslate"><span class="pre">sycl::queue</span></code>.  The function <code class="docutils literal notranslate"><span class="pre">find_least_loaded</span></code>
iterates through the resources available to the policy and returns the
resource with the fewest number of unfinished offloads.</p>
</section>
<section id="constructors">
<h2>Constructors<a class="headerlink" href="#constructors" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">dynamic_load_policy</span></code> provides three constructors.</p>
<table class="table" id="table-1">
<caption><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">dynamic_load_policy</span></code> constructors</span><a class="headerlink" href="#table-1" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Signature</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">dynamic_load_policy(deferred_initialization_t);</span></code></p></td>
<td><p>Defers initialization. An <code class="docutils literal notranslate"><span class="pre">initialize</span></code> function must be called prior to use.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">dynamic_load_policy();</span></code></p></td>
<td><p>Initialized to use the default set of resources.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">dynamic_load_policy(const</span> <span class="pre">std::vector&lt;resource_type&gt;&amp;</span> <span class="pre">u);</span></code></p></td>
<td><p>Overrides the default set of resources.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="deferred-initialization">
<h2>Deferred Initialization<a class="headerlink" href="#deferred-initialization" title="Permalink to this headline">¶</a></h2>
<p>A <code class="docutils literal notranslate"><span class="pre">dynamic_load_policy</span></code> that was constructed with deferred initialization must be
initialized by calling one of its <code class="docutils literal notranslate"><span class="pre">initialize</span></code> member functions before it can be used
to select or submit.</p>
<table class="table" id="table-2">
<caption><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">dynamic_load_policy</span></code> constructors</span><a class="headerlink" href="#table-2" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Signature</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">initialize();</span></code></p></td>
<td><p>Initialize to use the default set of resources.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">initialize(const</span> <span class="pre">std::vector&lt;resource_type&gt;&amp;</span> <span class="pre">u);</span></code></p></td>
<td><p>Overrides the default set of resources.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="queries">
<h2>Queries<a class="headerlink" href="#queries" title="Permalink to this headline">¶</a></h2>
<p>A <code class="docutils literal notranslate"><span class="pre">dynamic_load_policy</span></code> has <code class="docutils literal notranslate"><span class="pre">get_resources</span></code> and <code class="docutils literal notranslate"><span class="pre">get_submission_group</span></code>
member functions.</p>
<table class="table" id="table-3">
<caption><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">dynamic_load_policy</span></code> constructors</span><a class="headerlink" href="#table-3" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Signature</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">std::vector&lt;resource_type&gt;</span> <span class="pre">get_resources();</span></code></p></td>
<td><p>Returns the set of resources the policy is selecting from.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">auto</span> <span class="pre">get_submission_group();</span></code></p></td>
<td><p>Returns an object that can be used to wait for all active submissions.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="reporting-requirements">
<h2>Reporting Requirements<a class="headerlink" href="#reporting-requirements" title="Permalink to this headline">¶</a></h2>
<p>If a resource returned by <code class="docutils literal notranslate"><span class="pre">select</span></code> is used directly without calling
<code class="docutils literal notranslate"><span class="pre">submit</span></code> or <code class="docutils literal notranslate"><span class="pre">submit_and_wait</span></code>, it may be necessary to call <code class="docutils literal notranslate"><span class="pre">report</span></code>
to provide feedback to the policy. The <code class="docutils literal notranslate"><span class="pre">dynamic_load_policy</span></code> tracks the
number of outstanding submissions on each device via callbacks that report
when a submission is started, and when it is completed. The instrumentation
to report these events is included in the implementations of
<code class="docutils literal notranslate"><span class="pre">submit</span></code> and <code class="docutils literal notranslate"><span class="pre">submit_and_wait</span></code>.  However, if you use <code class="docutils literal notranslate"><span class="pre">select</span></code> and then
submit work directly to the selected resource, it is necessary to explicitly
report these events.</p>
<table class="table" id="table-4">
<caption><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">dynamic_load_policy</span></code> reporting requirements</span><a class="headerlink" href="#table-4" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><code class="docutils literal notranslate"><span class="pre">execution_info</span></code></p></th>
<th class="head"><p>is reporting required?</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">task_submission</span></code></p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">task_completion</span></code></p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">task_time</span></code></p></td>
<td><p>No</p></td>
</tr>
</tbody>
</table>
<p>In generic code, it is possible to perform compile-time checks to avoid
reporting overheads when reporting is not needed, while still writing
code that will work with any policy, as demonstrated below:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">select</span><span class="p">(</span><span class="n">my_policy</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="p">(</span><span class="n">report_info_v</span><span class="o">&lt;</span><span class="k">decltype</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="w"> </span><span class="n">execution_info</span><span class="o">::</span><span class="n">task_submission_t</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">s</span><span class="p">.</span><span class="n">report</span><span class="p">(</span><span class="n">execution_info</span><span class="o">::</span><span class="n">task_submission</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="round_robin_policy.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Round-Robin Policy</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="auto_tune_policy.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Auto-Tune Policy</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Intel<br/>
  
      &copy; Copyright Intel Corporation.<br/>
    <div class="extra_footer">
      <p align="right"><a data-cookie-notice="true" href="https://www.intel.com/content/www/us/en/privacy/intel-cookie-notice.html">Cookies</a></p>
    </div>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  

  </body>
</html>